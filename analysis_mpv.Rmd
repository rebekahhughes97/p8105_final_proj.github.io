---
title: "Analysis of Police Violence in the US"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(readr)
library(readxl)
library(patchwork)
library(leaflet)
library(rvest)
#you'll need to install the packages below in order to run animated plots or knit
library(gganimate)
library(gifski)
library(png)

knitr::opts_chunk$set(
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

mpv_df =
  read_csv("./data/mpv_final.csv")
```

Age Leaflet -- with symptoms of mental illness and whether officer was charged as label

```{r}
pal <- colorNumeric(
  palette = "viridis",
  domain = mpv_df$age)


mpv_df %>% 
  drop_na() %>% 
  mutate(
    lab = str_c("Age: ", age,
                "<br>Symptoms of Mental Illness: ", symptoms_of_mental_illness,
                "<br>Charges on the Police: ", criminal_charges)) %>%
  leaflet() %>% 
  addTiles() %>% 
  setView(-98.483330, 38.712046, zoom = 4) %>% 
  addLegend("bottomright", pal = pal,
            values = ~age,
            title = "Age",
            opacity = 1) %>% 
  addCircleMarkers(
    ~lng, ~lat,
    color = ~pal(age),
    radius = 0.5,
    popup = ~lab)
```


The plot below visualizes the total number of people killed by police, arranged by police department.

```{r}
police_dept_plot = 
  mpv_df %>% 
  count(police_dept) %>% 
  rename(total_killed_pd = n) %>% 
  filter(total_killed_pd >= 49) %>% 
  mutate(
    police_dept = factor(police_dept),
    police_dept = fct_reorder(police_dept, total_killed_pd)
  ) %>% 
  ggplot(aes(x = police_dept, y = total_killed_pd, fill = police_dept)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

police_dept_plot
```

The plots below visualize police killings by state. One includes all states with data, the other includes the top 10 states. 

```{r}
state_plot = 
  mpv_df %>% 
  count(state) %>% 
  rename(total_killed_st = n) %>% 
  arrange(desc(total_killed_st)) %>% 
  mutate(
    state = factor(state),
    state = fct_reorder(state, total_killed_st)
  ) %>% 
  ggplot(aes(x = state, y = total_killed_st, fill = state)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

state_subset_plot = 
  mpv_df %>% 
  count(state) %>% 
  rename(total_killed_st = n) %>% 
  arrange(desc(total_killed_st)) %>% 
  filter(total_killed_st >= 230) %>% 
  mutate(
    state = factor(state),
    state = fct_reorder(state, total_killed_st)
  ) %>% 
  ggplot(aes(x = state, y = total_killed_st, fill = state)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

state_plot + state_subset_plot
```

The plot below shows police killings over time until 2019 (I excluded 2020, because otherwise it looks like 2020 has a drop in police killings).

```{r}
year_plot = 
  mpv_df %>% 
  count(year) %>% 
  rename(total_killed = n) %>% 
  filter(year < 2020) %>% 
  ggplot(aes(x = year, y = total_killed)) + geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  scale_y_continuous(limit = c(0, 1400))

year_plot
```

Code below shows the breakdown of charges laid against police.

```{r}
mpv_case = 
  mpv_df %>% 
  count(criminal_charges) %>% 
  mutate(
    charges = case_when(
      startsWith(criminal_charges, "Charged") ~ "Yes",
      startsWith(criminal_charges, "No") ~ "No",
    )) %>% 
  ggplot(aes(x = charges, y = n)) +
  geom_col() 

mpv_case
```

Scatter plot showing killings over time separated by race

```{r}
anim_scatter =
  mpv_df %>% 
  group_by(year, race) %>% 
  count() %>% 
  ggplot(aes(x = year, y = n, color = race)) +
  geom_line() +
  geom_point() +
  labs(title = "Number of Police Killings Over Time by Race",
       x = "Year",
       y = "Number of Police Killings") +
  transition_reveal(year)

animate(anim_scatter, renderer = gifski_renderer())

# might be worth excluding 2020 because of incomplete data, it makes it look like the shootings are trending down
```

