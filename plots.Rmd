---
title: "Plotting"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(readr)
library(readxl)
library(patchwork)
#you'll need to install the packages below in order to run animated plots or knit
library(gganimate)
library(gifski)
library(png)

knitr::opts_chunk$set(
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# MPV Dataset

```{r, warning=FALSE}
mpv_df =
  read_csv("./data/mpv_final.csv")
```

The plot below visualizes the total number of people killed by police, arranged by police department.

```{r}
police_dept_plot = 
  mpv_df %>% 
  count(police_dept) %>% 
  rename(total_killed_pd = n) %>% 
  filter(total_killed_pd >= 49) %>% 
  mutate(
    police_dept = factor(police_dept),
    police_dept = fct_reorder(police_dept, total_killed_pd)
  ) %>% 
  ggplot(aes(x = police_dept, y = total_killed_pd, fill = police_dept)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

police_dept_plot
```

The plots below visualize police killings by state. One includes all states with data, the other includes the top 10 states. 

```{r}
state_plot = 
  mpv_df %>% 
  count(state) %>% 
  rename(total_killed_st = n) %>% 
  arrange(desc(total_killed_st)) %>% 
  mutate(
    state = factor(state),
    state = fct_reorder(state, total_killed_st)
  ) %>% 
  ggplot(aes(x = state, y = total_killed_st, fill = state)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

state_subset_plot = 
  mpv_df %>% 
  count(state) %>% 
  rename(total_killed_st = n) %>% 
  arrange(desc(total_killed_st)) %>% 
  filter(total_killed_st >= 230) %>% 
  mutate(
    state = factor(state),
    state = fct_reorder(state, total_killed_st)
  ) %>% 
  ggplot(aes(x = state, y = total_killed_st, fill = state)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

state_plot + state_subset_plot
```

The plot below shows police killings over time until 2019 (I excluded 2020, because otherwise it looks like 2020 has a drop in police killings).

```{r}
year_plot = 
  mpv_df %>% 
  count(year) %>% 
  rename(total_killed = n) %>% 
  filter(year < 2020) %>% 
  ggplot(aes(x = year, y = total_killed)) + geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  scale_y_continuous(limit = c(0, 1400))

year_plot
```

Code below shows the breakdown of charges laid against police.

```{r}
mpv_case = 
  mpv_df %>% 
  count(criminal_charges) %>% 
  mutate(
    charges = case_when(
      startsWith(criminal_charges, "Charged") ~ "Yes",
      startsWith(criminal_charges, "No") ~ "No",
    )) %>% 
  ggplot(aes(x = charges, y = n)) +
  geom_col() 

mpv_case
```

## Animated Plot

1. Scatter plot showing killings over time separated by race

```{r}
anim_scatter =
  mpv_df %>% 
  group_by(year, race) %>% 
  count() %>% 
  ggplot(aes(x = year, y = n, color = race)) +
  geom_line() +
  geom_point() +
  labs(title = "Number of Police Killings Over Time by Race",
       x = "Year",
       y = "Number of Police Killings") +
  transition_reveal(year)

animate(anim_scatter, renderer = gifski_renderer())

# might be worth excluding 2020 because of incomplete data, it makes it look like the shootings are trending down
```


# USA Protest Dataset

```{r}
protest_data =
  read_csv("./data/usa_tidy.csv")
```

Animated Scatter showing average number fatalities over the months by event type:

```{r}
anim_data =
  protest_data %>% 
  group_by(month, event_type) %>% 
  filter(event_type != "Battles") %>% 
  summarize(
    av_death = mean(fatalities)
  )

anim_plot =
  anim_data %>% 
  group_by(month) %>% 
  ggplot(aes(x = month, y = av_death, color = event_type)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Number of Fatalities over Time by Event Type",
       x = "Month",
       y = "Average Number of Fatalities") +
  transition_reveal(month)

animate(anim_plot, renderer = gifski_renderer())
```

2 bar charts showing the number of each event type compared to the number of each sub event type:

```{r}
bar_type =
  protest_data %>% 
  group_by(event_type) %>% 
  count() %>% 
  ggplot(aes(x = event_type, y = n, fill = event_type)) +
  geom_col() +
  geom_text(aes(x = event_type, y = n, label = n), position = position_dodge(width = 0.9), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "right")

bar_subtype =
  protest_data %>% 
  group_by(sub_event_type) %>% 
  count() %>% 
  ggplot(aes(x = sub_event_type, y = n, fill = sub_event_type)) +
  geom_col() +
  geom_text(aes(x = sub_event_type, y = n, label = n), position = position_dodge(width = 0.9), vjust = -0.25) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "right")

bar_type / bar_subtype
```

Scatter plots comparing fatalities each day over the course of each month:

```{r}
may =
  protest_data %>% 
  filter(month == 5) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in May",
       y = "Fatalities")

june =
  protest_data %>% 
  filter(month == 6) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in June",
       y = "Fatalities")

july = 
  protest_data %>% 
  filter(month == 7) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in July",
       y = "Fatalities")

august =
  protest_data %>% 
  filter(month == 8) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in August",
       y = "Fatalities")

sept =
  protest_data %>% 
  filter(month == 9) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in September",
       y = "Fatalities")

oct = 
  protest_data %>% 
  filter(month == 10) %>% 
  group_by(day) %>% 
  count(fatalities) %>% 
  ggplot(aes(x = day, y = n)) +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Fatalities in October",
       y = "Fatalities")

(may + june) / (july + august) / (sept + oct)
```

Plotly Plot:

```{r}

```

# ACS Datasets

```{r}
age_data =
  read_csv("./data/age_tidy.csv")

sex_data =
  read_csv("./data/age_sex_tidy.csv")

race_data =
  read_csv("./data/race_tidy.csv")

income_data =
  read_csv("./data/income_tidy.csv")
```

```{r}
age_data %>% 
  mutate(
    age = as.factor(age),
    age = fct_relevel(age, "0-5", "5 to 9")
  ) %>% 
  ggplot(aes(x = age, y = total)) +
  geom_col(aes(fill = age)) +
  labs(x = "", y = "", title = "Age of the US Population") +
  theme(axis.text.x = element_text(angle = 45))

sex_data %>%
  mutate(
    total = ifelse(sex == "female", total*(-1), total*(1)),
    percent = paste0(round(percent), "%")
  ) %>% 
  ggplot(aes(x = total, y = age)) +
  geom_col(aes(fill = sex)) +
  scale_x_continuous(labels = abs) +
  labs(x = "", y = "", title = "Age by Sex of the US Population")

race_data %>% 
  ggplot(aes(x = race, y = total)) +
  geom_col(aes(fill = race)) +
  labs(x = "", y = "", title = "US Population by Race")
  
income_data %>% 
  ggplot(aes(x = total_income, y = estimate_households)) +
  geom_col(aes(fill = total_income)) +
  labs(x = "Total Income per Household", y = "", title = "Income in US") +
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
income_df =
  read_csv("./data/income2.csv")

top_disparity = 
  income_df %>% 
  select(county, state, disparity_value) %>% 
  arrange(desc(disparity_value)) %>% 
  top_n(10) %>% 
  knitr::kable()

disparity_plot =
  income_df %>% 
    ggplot(aes(x = disparity_value)) + 
    geom_histogram()

#Top 10 wealth disparity

disparity_plot2 =
  income_df %>% 
  group_by(state) %>% 
  summarise(
    mean_disparity = mean(disparity_value)
  ) %>% 
  top_n(-10) %>% 
  mutate(
    state = fct_reorder(state, mean_disparity)
  ) %>% 
  ggplot(aes(x = state, y = mean_disparity, fill = state)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


#Bottom 10 wealth disparity

disparity_plot3 =
  income_df %>% 
  group_by(state) %>% 
  summarise(
    mean_disparity = mean(disparity_value)
  ) %>% 
  top_n(10) %>% 
  mutate(
    state = fct_reorder(state, mean_disparity)
  ) %>% 
  ggplot(aes(x = state, y = mean_disparity, fill = state)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#violin plots (not great, still in progress)

income_violin =
  income_df %>% 
  ggplot(aes(x = income_class, y = estimate_households_mean_income_dollars, fill = income_class)) + 
  geom_violin()

state_plot = 
  income_df %>%
  ggplot(aes(x = state, y = disparity_value)) + 
  geom_violin()
```

```{r}
build_df =
  read_csv("./data/build_df.csv")

build_plot = 
  build_df %>% 
  ggplot(aes(x = race, y = estimate_households_median_income_dollars)) + 
  geom_violin()

build_plot2 = 
  build_df %>% 
  ggplot(aes(x = symptoms_of_mental_illness, y = estimate_households_median_income_dollars)) + 
  geom_violin()
```

