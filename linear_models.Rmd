---
title: "Linear models"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

## Importing Data

```{r}
mpv_df_charges =
  read_csv("./data/mpv_final.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    charges = case_when(
      startsWith(criminal_charges, "Charged") ~ 1,
      startsWith(criminal_charges, "No") ~ 0),
    resolved = 
           ifelse(startsWith(disposition, "Pending"), 
                  {resolved = 0}, 
                  {resolved = 1}),
    race_rec = case_when(
      race == "Native American" ~ "Other",
      race == "Pacific Islander" ~ "Other",
      race == "Black" ~ "Black",
      race == "Hispanic" ~ "Other",
      race == "White" ~ "White",
      race == "Asian" ~ "Other"),
    race_rec = fct_infreq(race_rec),
    age_rec = 
      cut(age, breaks = c(0,20,40,60,100), right = FALSE),
    age_rec = fct_infreq(age_rec),
    MI = case_when(
      symptoms_of_mental_illness == "Yes" ~ 1,
      symptoms_of_mental_illness == "No" ~ 0,
      symptoms_of_mental_illness == "Drug or alcohol use" ~ 0),
    gunshot = case_when(
      cause_of_death == "Asphyxiated" ~ "No",
      cause_of_death == "Pepper Spray, Physical Restraint" ~ "No",
      cause_of_death == "Beaten Chemical agent/Pepper spray" ~ "No",
      cause_of_death == "Gunshot" ~ "Yes",
      cause_of_death == "Gunshot, Bean Bag Gun" ~ "Yes",
      cause_of_death == "Gunshot, Beanbag Gun" ~ "Yes",
      cause_of_death == "Gunshot, Pepper Spray" ~ "Yes",
      cause_of_death == "Gunshot, Police Dog" ~ "Yes",
      cause_of_death == "Gunshot, Stabbed" ~ "Yes",
      cause_of_death == "Gunshot, Taser" ~ "Yes",
      cause_of_death == "Gunshot, Unspecified Less Lethal Weapon" ~ "Yes",
      cause_of_death == "Gunshot, Vehicle" ~ "Yes",
      cause_of_death == "Other" ~ "No",
      cause_of_death == "Pepper Spray" ~ "No",
    )) %>% 
  filter(race_rec != "Other", gender != "Transgender") %>% 
  select(MI, age_rec, race_rec, charges, gender, gunshot, year, resolved)
```

## Model 1: Charges

Modeling charges laid as outcome and race as the exposure:

```{r}
xtabs(~charges + race_rec, data = mpv_df_charges) %>% 
  knitr::kable()

glm(charges ~ race_rec, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "race_rec", "Race: ")) %>% 
    knitr::kable(digits = 3)
```

Crude analyses show that, in instances where the victim of police violence is Black, the odds of charges being laid is increased by 112% (95% CI: 1.49, 3.03). 

The following code chunk explores potential confounders.

```{r}
#Year - Not significant, not further explored
glm(charges ~ year, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy()

#Gender - Significant, further explored
glm(charges ~ gender, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy()

glm(charges ~ race_rec + gender, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy()

#Age - Not significant, not further explored
glm(charges ~ age_rec, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy()
```

Adjusted analysis included gender as a confounder.

```{r}
glm(charges ~ race_rec + gender, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "race_rec", "Race: ")) %>% 
    knitr::kable(digits = 3)
```

Adjusted analyses show that, in instances where the victim of police violence is Black, the odds of charges being laid is increased by 136% (95% CI: 1.65, 3.39).

#### Sensitivity Analysis: Model 1

We then opted to conducted a sensitivity analysis, exploring whether a pending investigation was the cause for what seems like a spuriously inflated OR. Therefore, we restricted the sample to only resolved cases.

```{r}
mpv_solved = 
  mpv_df_charges %>% 
  filter(resolved == "1")

glm(charges ~ race_rec + gender, data = mpv_solved, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "race_rec", "Race: ")) %>% 
    knitr::kable(digits = 3)
```

Adjusted analyses show that, in instances where the victim of police violence is Black, the odds of charges being laid is increased by 128% (95% CI: 1.57, 3.32), adjusting for gender. Restricting to solved cases did not change the association.

## Model 2: Symptoms of Mental Illness

Modeling symptoms of mental illness as outcome.

```{r}
xtabs(~MI + gender, data = mpv_df_charges)

glm(MI ~ gender, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "gender", "Gender: ")) %>% 
    knitr::kable(digits = 3)
```

Gender is significantly associated with MI; males are 40% less likely to exhibit symptoms of mental illness among those killed by police (OR: 0.60; 95% CI: 0.46, 0.78).

```{r}
glm(MI ~ race_rec, data = mpv_df_charges, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "race_rec", "Race: ")) %>% 
    knitr::kable(digits = 3)
```

Race is also significantly associated with symptoms of mental illness, in that Black individuals have 0.40 times the odds of reporting symptoms of mental illness (95% CI: 0.34, 0.46).

#### Sensitivity Analysis: Model 2

```{r}
glm(MI ~ gender + race_rec, data = mpv_solved, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  mutate(
    term = str_replace(term, "race_rec", "Race: ")) %>% 
    knitr::kable(digits = 3)
```

After restricting to solved cases, gender was no longer significantly associated with symptoms of mental illness.
